#!/bin/bash

# Install packages from pkglist.txt
if command -v pacman &> /dev/null; then
    echo "Installing packages with pacman..."
    sudo pacman -S --needed --noconfirm $(cat {{ .chezmoi.sourceDir }}/pkglist.txt | grep -v '^#' | tr '\n' ' ')
fi

# Install NVM and Node.js 20.11.1
if ! command -v nvm &> /dev/null; then
    echo "Installing NVM..."
    # Install NVM
    curl -o- https://raw.githubusercontent.com/nvm-sh/nvm/v0.39.0/install.sh | bash
    
    # Source NVM and install Node.js if installation succeeded
    if [ -f ~/.nvm/nvm.sh ]; then
        source ~/.nvm/nvm.sh
        nvm install 20.11.1
        nvm use 20.11.1
        nvm alias default 20.11.1
        echo "NVM and Node.js 20.11.1 installed successfully"
    else
        echo "NVM installation failed - scripts not found"
    fi
else
    echo "NVM already installed, ensuring Node.js 20.11.1 is available..."
    source ~/.nvm/nvm.sh 2>/dev/null || source /usr/share/nvm/nvm.sh
    if ! nvm list | grep -q "20.11.1"; then
        nvm install 20.11.1
    fi
    nvm use 20.11.1
    nvm alias default 20.11.1
fi

# Install RVM and Ruby 1.9.3
if ! command -v rvm &> /dev/null; then
    echo "Installing RVM..."
    # Import GPG keys first
    gpg --keyserver hkp://keyserver.ubuntu.com --recv-keys 409B6B1796C275462A1703113804BB82D39DC0E3 7D2BAF1CF37B13E2069D6956105BD0E739499BDB || {
        echo "GPG keyserver failed, importing keys from URLs..."
        curl -sSL https://rvm.io/mpapis.asc | gpg --import -
        curl -sSL https://rvm.io/pkuczynski.asc | gpg --import -
    }
    
    # Install RVM
    curl -sSL https://get.rvm.io | bash -s stable
    
    # Source RVM and install Ruby if installation succeeded
    if [ -f ~/.rvm/scripts/rvm ]; then
        source ~/.rvm/scripts/rvm
        rvm install 1.9.3
        rvm use 1.9.3 --default
        echo "RVM and Ruby 1.9.3 installed successfully"
    else
        echo "RVM installation failed - scripts not found"
    fi
else
    echo "RVM already installed, ensuring Ruby 1.9.3 is available..."
    source ~/.rvm/scripts/rvm
    if ! rvm list | grep -q "1.9.3"; then
        rvm install 1.9.3
    fi
    rvm use 1.9.3 --default
fi

# Install GVM
if ! command -v gvm &> /dev/null; then
    echo "Installing GVM..."
    bash < <(curl -s -S -L https://raw.githubusercontent.com/moovweb/gvm/master/binscripts/gvm-installer)

    if [ -f ~/.gvm/scripts/gvm ]; then
        echo "GVM installed successfully"
    else
        echo "GVM installation failed - scripts not found"
    fi
fi
